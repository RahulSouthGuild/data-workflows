# primary_sales_view - Schema Definition
# Converted from 02_PrimarySalesView.py
# Type: VIEW
# Order: 10

name: primary_sales_view
type: VIEW
order: 10
sql: "CREATE VIEW primary_sales_view AS\n    SELECT\n        fid.customer_code AS wss_code,\n        UPPER(dcm.customer_group) AS wss_group,\n        UPPER(dcm.customer_group_1) AS wss_group_1,\n        UPPER(dcm.customer_group_3) AS wss_group_3,\n        UPPER(dcm.customer_group_3_status) AS wss_group_3_status,\n        UPPER(dcm.customer_name) AS wss_name,\n        UPPER(dcm.customer_block) AS wss_block,\n        UPPER(dcm.district) AS wss_district,\n        dcm.payment_method_name AS payment_method_name,\n        dcm.credit_limit AS credit_limit,\n        dcm.customer_creation_date AS customer_creation_date,\n        dcm.population AS population,\n        fid.division_code AS division,\n        dmm_concat.final_classification AS final_classification,\n        dcm.grand_parent_customer_code AS grand_parent_wss_code,\n        fid.invoice_no AS invoice_no,\n        fid.invoice_type AS invoice_type,\n        fid.posting_date AS invoice_date,\n        dcm.parent_customer_code AS parent_wss_code,\n\
  \        fid.billing_quantity_in_stock_keeping_unit AS quantity,\n        UPPER(dcm.pop_strata) AS pop_strata,\n        UPPER(dm.product_group_1_description) AS product_category,\n        UPPER(dm.product_group_2_description) AS product_sub_category,\n        UPPER(dm.product_group_3_description) AS product_name,\n        dm.product_group_5_description AS pack_size,\n        fid.material_division AS product_division_code,\n        fid.mis_type AS mis_type,\n        CASE\n            WHEN fid.mis_type = 'CN' THEN -1 * fid.net_value\n            ELSE fid.net_value\n        END AS sales,\n        fid.sales_group_code AS sales_group_code,\n        UPPER(dmm.brand) AS brand,\n        dcm.sale_group_name AS sales_group,\n        UPPER(dcm.region) AS sh_5_name,\n        dcm.region_code AS sh_5_code,\n        UPPER(dmm_concat.vertical) AS vertical,\n        dmm.material_code AS material_code,\n        dmm.parent_division_code AS parent_division_code,\n        dmm.parent_division_name AS parent_division_name,\n\
  \        dmm.material_code_sg_key AS material_code_sg_key,\n        UPPER(dcm.cluster) AS sh_3_name,\n        dcm.cluster_code AS sh_3_code,\n        dcm.branch AS sh_4_name,\n        dcm.branch_code AS sh_4_code,\n        UPPER(dcm.zone) AS sh_6_name,\n        dcm.zone_code AS sh_6_code,\n        UPPER(dsg.vertical) AS sales_group_name,\n        UPPER(dcm.state) AS wss_state,\n        dcm.term_of_payment AS term_of_payment,\n        dcm.tsi_grouping AS tsi_grouping,\n        dcm.tsi_territory_code AS tsi_code,\n        UPPER(TRIM(dcm.tsi_territory_name)) AS tsi_name,\n        fid.reporting_unit AS volume,\n        dcm.winomkar_wss_flag AS winomkar_wss_flag,\n        dcm.wss_territory_code AS wss_territory_code,\n        UPPER(dcm.wss_territory_name) AS wss_territory_name,\n        UPPER(dcm.town) AS wss_town\n    FROM\n        fact_invoice_details fid\n        LEFT JOIN dim_customer_master dcm ON fid.customer_code = dcm.customer_code\n        LEFT JOIN dim_sales_group dsg ON fid.sales_group_code\
  \ = dsg.sales_group\n        LEFT JOIN dim_material dm ON fid.material_code = dm.material_code\n        LEFT JOIN dim_material_mapping dmm ON fid.material_code = dmm.material_code\n        -- Optimized join for Vertical and FinalClassification\n        LEFT JOIN dim_material_mapping dmm_concat ON CONCAT(fid.material_code, fid.sales_group_code) = dmm_concat.material_code_sg_key\n    WHERE\n        fid.active_flag = '1'\n        AND fid.mis_type IN ('CN', 'INV')"
