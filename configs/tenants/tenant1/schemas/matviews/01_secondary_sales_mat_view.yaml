# secondary_sales_mat_view - Schema Definition
# Converted from 01_SecondarySalesMatView.py
# Type: MATVIEW
# Order: 9

name: secondary_sales_mat_view
type: MATVIEW
order: 9
sql: "CREATE MATERIALIZED VIEW secondary_sales_mat_view\n    DISTRIBUTED BY HASH(wss_territory_code)\n    BUCKETS 10\n    REFRESH ASYNC START('2025-12-05 00:00:00') EVERY (interval 1 day)\nAS\nSELECT\n    dcm.customer_code AS wss_code,\n    dcm.customer_group_3 AS wss_group_3,\n    UPPER(dcm.customer_name) AS wss_name,\n    UPPER(ddm.dealer_city) AS dealer_city,\n    ddm.dealer_class AS dealer_class,\n    UPPER(ddm.dealer_district) AS dealer_district,\n    ddm.dealer_code AS dealer_code,\n    ddm.dealer_group_code AS dealer_group_code,\n    ddm.dealer_name AS dealer_name,\n    UPPER(ddm.dealer_route_name) AS dealer_route_name,\n    UPPER(ddm.dealer_state) AS dealer_state,\n    ddm.tsi_type AS dealer_tsi_type,\n    UPPER(ddm.dealer_type_1) AS dealer_type_1,\n    ddm.dealer_type_2 AS dealer_type_2,\n    ddm.dealer_type_3 AS dealer_type_3,\n    UPPER(ddm.dealer_type_4) AS dealer_type_4,\n    ddm.dealer_type_5 AS dealer_type_5,\n    UPPER(ddm.dealer_type_6) AS dealer_type_6,\n    UPPER(ddm.dealer_type_7)\
  \ AS dealer_type_7,\n    UPPER(ddm.dealer_type_12) AS dealer_type_12,\n    UPPER(dsg.division) AS division,\n    dmm_concat.final_classification AS final_classification,\n    UPPER(dmm.brand) AS brand,\n    UPPER(dmm_concat.vertical) AS vertical,\n    fis.invoice_date AS invoice_date,\n    fis.invoice_no AS invoice_no,\n    dmm.parent_division_name AS parent_division_name,\n    UPPER(dcm.pop_strata) AS pop_strata,\n    dm.material_description AS product_description,\n    dm.sales_group_code AS product_division_code,\n    dsg.vertical AS sub_division,\n    UPPER(dm.product_group_1_description) AS product_category,\n    UPPER(dm.product_group_2_description) AS product_sub_category,\n    UPPER(dm.product_group_3_description) AS product_name,\n    dm.product_group_5_description AS pack_size,\n    fis.reporting_unit_in_each AS quantity,\n    fis.record_type AS record_type,\n    fis.reporting_value AS sales,\n    fis.revised_net_value_mvg AS uvg,\n    dsg.vertical AS sales_group,\n    fis.sales_group_code\
  \ AS sales_group_code,\n    UPPER(dsg.vertical) AS sales_group_name,\n    dcm.cluster_code AS sh_3_code,\n    UPPER(dcm.cluster) AS sh_3_name,\n    dcm.branch_code AS sh_4_code,\n    dcm.branch AS sh_4_name,\n    dcm.cm_region_code AS sh_5_code,\n    UPPER(dcm.region) AS sh_5_name,\n    dcm.zone_code AS sh_6_code,\n    UPPER(dcm.zone) AS sh_6_name,\n    ddm.tsi_territory_code AS tsi_code,\n    UPPER(TRIM(dcm.tsi_territory_name)) AS tsi_name,\n    UPPER(TRIM(dh.sh_2_name)) AS tsr_name,\n    fis.reporting_unit AS volume,\n    dcm.wss_territory_code AS wss_territory_code,\n    UPPER(dcm.wss_territory_name) AS wss_territory_name,\n    UPPER(dcm.town) AS wss_town,\n    fis.dealer_sg_key AS dealer_sg_key,\n    ddm.tsi_code AS ssdm_tsr_code,\n    ddm.tsi_name AS ssdm_tsr_name\nFROM\n    fact_invoice_secondary fis\n    LEFT JOIN dim_sales_group dsg ON fis.sales_group_code = dsg.sales_group\n    LEFT JOIN dim_material dm ON fis.item_code = dm.material_code\n    AND dm.active_flag = 'True'\n   \
  \ AND dm.material_type = 'ZFGD'\n    LEFT JOIN dim_dealer_master ddm ON CAST(fis.dealer_sg_key AS STRING) = CAST(ddm.dealer_sg_key AS STRING)\n    AND ddm.active_flag = 'True'\n    LEFT JOIN dim_customer_master dcm ON CAST(ddm.customer_code AS STRING) = CAST(dcm.customer_code AS STRING)\n    LEFT JOIN dim_material_mapping dmm ON fis.item_code = dmm.material_code\n    -- New optimized join for vertical and final_classification using material_code_sg_key\n    LEFT JOIN dim_material_mapping dmm_concat ON CONCAT(\n        CAST(fis.item_code AS STRING),\n        CAST(fis.sales_group_code AS STRING)\n    ) = dmm_concat.material_code_sg_key\n    -- Hierarchy join with row number for latest record (StarRocks compatible)\n    LEFT JOIN (\n        SELECT\n            sh_2_code,\n            sh_2_name\n        FROM\n            (\n                SELECT\n                    sh_2_code,\n                    sh_2_name,\n                    ROW_NUMBER() OVER (\n                        PARTITION BY\n\
  \                            sh_2_code\n                        ORDER BY\n                            primary_key DESC\n                    ) as rn\n                FROM\n                    dim_hierarchy\n            ) t\n        WHERE\n            t.rn = 1\n    ) dh ON ddm.tsi_territory_code = dh.sh_2_code\nWHERE\n    fis.active_flag = '1'\n    AND fis.invoice_date >= '20230401';"
comments:
  view: Secondary sales materialized view with territory mapping for RLS
  performance: 50ms query time (vs 205ms for dynamic views)
  refresh: ASYNC - scheduled daily at 00:00 UTC, requires manual refresh after creation
  columns:
    wss_territory_code: Territory code for RLS filtering (distribution key)
    region: Region information from territory mapping
  fixes:
    distinction: Uses ROW_NUMBER() instead of DISTINCT ON (StarRocks compatible)
    joins: Added dmm_concat and hierarchy joins for complete territory data
    start_time: Set to past (2025-12-05 00:00:00) so refresh triggers immediately
